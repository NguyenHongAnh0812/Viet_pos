<!DOCTYPE html>
<html>
  <head>
    <script src="https://cdn.ckeditor.com/ckeditor5/40.1.0/classic/ckeditor.js"></script>
    <style>
      html, body { 
        height: 100%; 
        margin: 0; 
        padding: 0;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      }
      #editor { 
        height: 100%; 
        min-height: 200px;
        max-height: 800px;
        overflow-y: auto;
      }
      .ck-editor__editable {
        min-height: 200px !important;
        max-height: 800px !important;
        overflow-y: auto !important;
        padding: 16px !important;
        line-height: 1.6 !important;
      }
      /* Enhanced table styling */
      .ck-editor__editable table {
        width: 100% !important;
        border-collapse: collapse !important;
        margin: 16px 0 !important;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
      }
      .ck-editor__editable table td,
      .ck-editor__editable table th {
        border: 1px solid #e0e0e0 !important;
        padding: 12px 16px !important;
        text-align: left !important;
        vertical-align: top !important;
      }
      .ck-editor__editable table th {
        background-color: #f8f9fa !important;
        font-weight: 600 !important;
        color: #333 !important;
      }
      .ck-editor__editable table tr:nth-child(even) {
        background-color: #fafafa !important;
      }
      .ck-editor__editable table tr:hover {
        background-color: #f0f8ff !important;
      }
      /* Better list styling */
      .ck-editor__editable ul, .ck-editor__editable ol {
        padding-left: 24px !important;
        margin: 8px 0 !important;
      }
      .ck-editor__editable li {
        margin: 4px 0 !important;
      }
      /* Blockquote styling */
      .ck-editor__editable blockquote {
        border-left: 4px solid #007bff !important;
        margin: 16px 0 !important;
        padding: 12px 20px !important;
        background-color: #f8f9fa !important;
        font-style: italic !important;
      }
      /* Link styling */
      .ck-editor__editable a {
        color: #007bff !important;
        text-decoration: underline !important;
      }
      .ck-editor__editable a:hover {
        color: #0056b3 !important;
      }
      /* Code styling */
      .ck-editor__editable code {
        background-color: #f1f3f4 !important;
        padding: 2px 6px !important;
        border-radius: 4px !important;
        font-family: 'Courier New', monospace !important;
        font-size: 0.9em !important;
      }
      /* Custom toolbar styling */
      .ck.ck-toolbar {
        border-radius: 8px 8px 0 0 !important;
        border-bottom: 1px solid #e0e0e0 !important;
      }
      .ck.ck-editor__main {
        border-radius: 0 0 8px 8px !important;
      }
    </style>
    <script>
      let editorInstance;
      let lastHeight = 200;
      let isInitialized = false;
      
      // Function to notify Flutter about height changes
      function notifyHeightChange(height) {
        if (window.parent && window.parent.postMessage) {
          window.parent.postMessage({
            type: 'editorHeightChange',
            height: height
          }, '*');
        }
      }
      
      // Function to get content height
      function getContentHeight() {
        if (!editorInstance) return 200;
        
        const editorElement = editorInstance.ui.view.element;
        const editableElement = editorInstance.ui.view.editable.element;
        
        if (editableElement) {
          const contentHeight = editableElement.scrollHeight;
          const toolbarHeight = editorInstance.ui.view.toolbar.element.offsetHeight || 50;
          const minHeight = 200;
          const maxHeight = 800;
          return Math.max(minHeight, Math.min(maxHeight, contentHeight + toolbarHeight + 20));
        }
        
        return 200;
      }
      
      // Auto-resize function with debouncing
      let resizeTimeout;
      function autoResize() {
        if (resizeTimeout) {
          clearTimeout(resizeTimeout);
        }
        
        resizeTimeout = setTimeout(() => {
          if (editorInstance && isInitialized) {
            const newHeight = getContentHeight();
            if (Math.abs(newHeight - lastHeight) > 10) {
              lastHeight = newHeight;
              notifyHeightChange(newHeight);
            }
          }
        }, 100);
      }
      
      // Enhanced content getter
      window.getCKContent = function() {
        if (!editorInstance) return '';
        
        try {
          const content = editorInstance.getData();
          return content || '';
        } catch (error) {
          console.error('Error getting content:', error);
          return '';
        }
      }
      
      // Enhanced content setter
      window.setCKContent = function(content) {
        if (editorInstance && isInitialized) {
          try {
            editorInstance.setData(content || '');
            setTimeout(autoResize, 150);
          } catch (error) {
            console.error('Error setting content:', error);
          }
        }
      }
      
      // Function to focus editor
      window.focusEditor = function() {
        if (editorInstance) {
          editorInstance.focus();
        }
      }
      
      // Function to get word count
      window.getWordCount = function() {
        if (!editorInstance) return 0;
        
        const data = editorInstance.getData();
        const textContent = data.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();
        return textContent.split(' ').filter(word => word.length > 0).length;
      }
      
      window.onload = function() {
        ClassicEditor
          .create(document.querySelector('#editor'), {
            toolbar: {
              items: [
                'undo', 'redo', '|',
                'heading', '|',
                'bold', 'italic', 'underline', 'strikethrough', '|',
                'fontSize', 'fontFamily', 'fontColor', 'fontBackgroundColor', '|',
                'alignment', '|',
                'bulletedList', 'numberedList', '|',
                'indent', 'outdent', '|',
                'link', 'blockQuote', '|',
                'insertTable', '|',
                'horizontalLine', '|',
                'removeFormat', '|',
                'sourceEditing'
              ],
              shouldNotGroupWhenFull: true
            },
            removePlugins: [
              'CKFinderUploadAdapter', 
              'CKFinder', 
              'EasyImage', 
              'Image', 
              'ImageCaption', 
              'ImageStyle', 
              'ImageToolbar', 
              'ImageUpload',
              'MediaEmbed',
              'PageBreak'
            ],
            table: {
              contentToolbar: [
                'tableColumn',
                'tableRow',
                'mergeTableCells',
                'tableProperties',
                'tableCellProperties',
                'toggleTableCaption'
              ],
              defaultProperties: {
                borderWidth: '1px',
                borderColor: '#e0e0e0',
                backgroundColor: '#ffffff',
                width: '100%'
              }
            },
            heading: {
              options: [
                { model: 'paragraph', title: 'Paragraph', class: 'ck-heading_paragraph' },
                { model: 'heading1', view: 'h1', title: 'Heading 1', class: 'ck-heading_heading1' },
                { model: 'heading2', view: 'h2', title: 'Heading 2', class: 'ck-heading_heading2' },
                { model: 'heading3', view: 'h3', title: 'Heading 3', class: 'ck-heading_heading3' },
                { model: 'heading4', view: 'h4', title: 'Heading 4', class: 'ck-heading_heading4' },
                { model: 'heading5', view: 'h5', title: 'Heading 5', class: 'ck-heading_heading5' },
                { model: 'heading6', view: 'h6', title: 'Heading 6', class: 'ck-heading_heading6' }
              ]
            },
            fontSize: {
              options: [8, 10, 12, 14, 'default', 16, 18, 20, 22, 24, 26, 28, 30, 32, 34, 36, 38, 40, 42, 44, 46, 48, 50]
            },
            fontFamily: {
              options: [
                'default',
                'Arial, Helvetica, sans-serif',
                'Courier New, Courier, monospace',
                'Georgia, serif',
                'Lucida Sans Unicode, Lucida Grande, sans-serif',
                'Tahoma, Geneva, sans-serif',
                'Times New Roman, Times, serif',
                'Trebuchet MS, Helvetica, sans-serif',
                'Verdana, Geneva, sans-serif',
                'Roboto, sans-serif',
                'Open Sans, sans-serif',
                'Lato, sans-serif'
              ]
            },
            fontColor: {
              colors: [
                { color: 'hsl(0, 0%, 0%)', label: 'Black' },
                { color: 'hsl(0, 0%, 30%)', label: 'Dim grey' },
                { color: 'hsl(0, 0%, 60%)', label: 'Grey' },
                { color: 'hsl(0, 0%, 90%)', label: 'Light grey' },
                { color: 'hsl(0, 0%, 100%)', label: 'White', hasBorder: true },
                { color: 'hsl(0, 100%, 50%)', label: 'Red' },
                { color: 'hsl(30, 100%, 50%)', label: 'Orange' },
                { color: 'hsl(60, 100%, 50%)', label: 'Yellow' },
                { color: 'hsl(90, 100%, 50%)', label: 'Light green' },
                { color: 'hsl(120, 100%, 50%)', label: 'Green' },
                { color: 'hsl(150, 100%, 50%)', label: 'Aquamarine' },
                { color: 'hsl(180, 100%, 50%)', label: 'Turquoise' },
                { color: 'hsl(210, 100%, 50%)', label: 'Light blue' },
                { color: 'hsl(240, 100%, 50%)', label: 'Blue' },
                { color: 'hsl(270, 100%, 50%)', label: 'Magenta' },
                { color: 'hsl(300, 100%, 50%)', label: 'Pink' }
              ]
            },
            fontBackgroundColor: {
              colors: [
                { color: 'hsl(0, 0%, 0%)', label: 'Black' },
                { color: 'hsl(0, 0%, 30%)', label: 'Dim grey' },
                { color: 'hsl(0, 0%, 60%)', label: 'Grey' },
                { color: 'hsl(0, 0%, 90%)', label: 'Light grey' },
                { color: 'hsl(0, 0%, 100%)', label: 'White', hasBorder: true },
                { color: 'hsl(0, 100%, 50%)', label: 'Red' },
                { color: 'hsl(30, 100%, 50%)', label: 'Orange' },
                { color: 'hsl(60, 100%, 50%)', label: 'Yellow' },
                { color: 'hsl(90, 100%, 50%)', label: 'Light green' },
                { color: 'hsl(120, 100%, 50%)', label: 'Green' },
                { color: 'hsl(150, 100%, 50%)', label: 'Aquamarine' },
                { color: 'hsl(180, 100%, 50%)', label: 'Turquoise' },
                { color: 'hsl(210, 100%, 50%)', label: 'Light blue' },
                { color: 'hsl(240, 100%, 50%)', label: 'Blue' },
                { color: 'hsl(270, 100%, 50%)', label: 'Magenta' },
                { color: 'hsl(300, 100%, 50%)', label: 'Pink' }
              ]
            },
            link: {
              defaultProtocol: 'https://',
              decorators: {
                addTargetToExternalLinks: true,
                defaultProtocol: 'https://',
                toggleDownloadLink: {
                  mode: 'manual',
                  label: 'Downloadable',
                  attributes: {
                    download: 'file'
                  }
                }
              }
            }
          })
          .then(editor => {
            editorInstance = editor;
            isInitialized = true;
            
            // Listen for content changes to auto-resize
            editor.model.document.on('change:data', () => {
              autoResize();
            });
            
            // Enhanced table handling
            editor.model.document.on('change:data', () => {
              const changes = editor.model.document.differ.getChanges();
              changes.forEach(change => {
                if (change.type === 'insert' && change.name === 'table') {
                  const tableElement = change.position.nodeAfter;
                  if (tableElement && tableElement.is('element', 'table')) {
                    editor.model.change(writer => {
                      writer.setAttribute('width', '100%', tableElement);
                      writer.setAttribute('border', '1', tableElement);
                      writer.setAttribute('cellpadding', '12', tableElement);
                      writer.setAttribute('cellspacing', '0', tableElement);
                    });
                  }
                }
              });
            });
            
            // Auto-save functionality (optional)
            let saveTimeout;
            editor.model.document.on('change:data', () => {
              if (saveTimeout) {
                clearTimeout(saveTimeout);
              }
              saveTimeout = setTimeout(() => {
                // Notify Flutter about content change for auto-save
                if (window.parent && window.parent.postMessage) {
                  window.parent.postMessage({
                    type: 'contentChanged',
                    content: editor.getData()
                  }, '*');
                }
              }, 2000); // Auto-save after 2 seconds of inactivity
            });
            
            // Initial resize
            setTimeout(autoResize, 200);
            
            // Notify Flutter that editor is ready
            if (window.parent && window.parent.postMessage) {
              window.parent.postMessage({
                type: 'editorReady',
                height: getContentHeight()
              }, '*');
            }
          })
          .catch(error => {
            console.error('CKEditor error:', error);
            // Notify Flutter about error
            if (window.parent && window.parent.postMessage) {
              window.parent.postMessage({
                type: 'editorError',
                error: error.message
              }, '*');
            }
          });
      }
    </script>
  </head>
  <body>
    <div id="editor"></div>
  </body>
</html> 